# Infrastructure - Слой Инфраструктуры

Слой **Infrastructure** является важной частью проекта "Платежи с рассрочкой", отвечая за взаимодействие с внешними системами и службами, такими как базы данных и другие хранилища данных. В этом слое реализуются все механизмы для работы с базой данных и другими внешними сервисами.

## Основные компоненты Infrastructure

### 1. **DataContext**

`DataContext` представляет собой контекст базы данных, который используется для взаимодействия с Entity Framework Core. Он управляет сущностями и выполняет операции с базой данных.

- **Основная цель**: Управление сущностями и их маппинг в базу данных.
- **Реализация**: Этот контекст инкапсулирует все взаимодействие с базой данных, включая чтение и запись данных через Entity Framework.

### 2. **Migrations**

Механизм миграций используется для управления схемой базы данных. Он позволяет автоматически обновлять структуру базы данных при изменении моделей данных или добавлении новых сущностей.

- **Основная цель**: Управление схемой базы данных и внесение изменений в базу данных на основе изменений в моделях данных.
- **Реализация**: С помощью миграций можно создавать, обновлять или удалять таблицы, индексы и другие объекты базы данных.

### 3. **EfCore (Entity Framework Core)**

Этот класс содержит утилитные методы для работы с Entity Framework Core, включая фильтрацию данных и пагинацию.

- **Фильтрация удаленных сущностей**: Реализует фильтрацию данных с учетом "мягкого удаления". То есть, записи, которые были помечены как удаленные, не будут возвращаться в запросах.
- **Пагинация**: Реализует логику пагинации для выборки данных из базы данных.

Пример утилитного метода для фильтрации:

```csharp
public static class EfCore
{
    public static void FilterSoftDeletedProperties(this ModelBuilder modelBuilder)
    {
        Expression<Func<BaseEntity, bool>> filterExpr = e => !e.IsDeleted;
        foreach (IMutableEntityType mutableEntityType in modelBuilder.Model.GetEntityTypes()
                     .Where(m => m.ClrType.IsAssignableTo(typeof(BaseEntity))))
        {
            ParameterExpression parameter = Expression.Parameter(mutableEntityType.ClrType);
            Expression body = ReplacingExpressionVisitor
                .Replace(filterExpr.Parameters.First(), parameter, filterExpr.Body);
            LambdaExpression lambdaExpression = Expression.Lambda(body, parameter);

            mutableEntityType.SetQueryFilter(lambdaExpression);
        }
    }

    public static IEnumerable<T> Page<T>(this IEnumerable<T> entity, int pageNumber, int pageSize)
        => entity.Skip((pageNumber - 1) * pageSize).Take(pageSize);
}
```

# ImplementationContract - Реализация Контрактов Репозиториев и Сервисов

Слой **ImplementationContract** отвечает за реализацию бизнес-логики приложения, включая работу с данными и выполнением операций на уровне репозиториев и сервисов. Этот слой содержит конкретные реализации интерфейсов, описывающих работу с базой данных и обработку запросов, что позволяет приложению взаимодействовать с данными.

## Основные задачи слоя **Infrastructure**

1. **Реализация Repository и Service**:
   В этом слое находятся конкретные реализации интерфейсов репозиториев и сервисов. Репозитории отвечают за операции с данными (например, CRUD операции), а сервисы обеспечивают выполнение бизнес-логики и обработку запросов, приходящих от контроллеров.

2. **Работа с базой данных**:
   Слой **Infrastructure** управляет связью с базой данных через **DataContext**. Все операции с базой данных, включая создание, чтение, обновление и удаление данных, происходят здесь. Этот слой инкапсулирует все детали работы с базой данных, обеспечивая единый интерфейс для взаимодействия с хранилищем данных.

3. **Миграции**:
   Слой **Infrastructure** управляет схемой базы данных, создавая и синхронизируя изменения в моделях с реальной структурой базы данных. Миграции помогают при обновлениях, создании новых таблиц и изменении существующих.

4. **Утилиты для работы с данными**:
   Включает вспомогательные методы для фильтрации и пагинации данных, что помогает эффективно обрабатывать большие объемы информации. Например, фильтрация удаленных записей с использованием концепции **Soft Delete** и пагинация данных для улучшения производительности запросов.

## Заключение

Слой **Infrastructure** играет критическую роль в обеспечении взаимодействия приложения с внешними сервисами, такими как базы данных. Он инкапсулирует всю логику работы с данными и внешними ресурсами, предоставляя стандартизованный доступ к ним. Это позволяет улучшить тестируемость, масштабируемость и заменяемость технологий в проекте.

Кроме того, слой **Infrastructure** облегчает работу с базой данных, миграциями и различными утилитами, что делает приложение более гибким и адаптируемым к изменениям в будущем.
